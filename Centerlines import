import bpy
import json
from pathlib import Path
from mathutils import Vector, Matrix
import math

# ====== SETTINGS ======
JSON_PATH = r'/Users/tkimura/Desktop/Blender/Vessel Path/centerline_polylines_mm_centered.json' # ← centered版
COLLECTION_NAME = "Centerlines_JSON"

MM_TO_BU = 0.02          # 1mm → 0.02 BU（あなたのCT表示に合わせる）
ROT_X_DEG = -90.0        # 仰臥位（頭尾をYへ）

BEVEL_DEPTH_MM = 0.6
BEVEL_RESOLUTION = 2
# ======================

def ensure_collection(name: str):
    col = bpy.data.collections.get(name)
    if col is None:
        col = bpy.data.collections.new(name)
        bpy.context.scene.collection.children.link(col)
    return col

def import_centered_polylines_curve(json_path: str):
    p = Path(json_path)
    if not p.exists():
        raise FileNotFoundError(f"JSON not found: {p}")

    data = json.loads(p.read_text(encoding="utf-8"))
    polylines = data.get("polylines", [])
    if not polylines:
        raise ValueError("No 'polylines' found in JSON.")

    # （任意）meta確認
    meta = data.get("meta", {})
    anchor = meta.get("anchor", {})
    print("anchor meta:", anchor)

    col = ensure_collection(COLLECTION_NAME)

    curve_data = bpy.data.curves.new(name=p.stem, type='CURVE')
    curve_data.dimensions = '3D'
    curve_data.resolution_u = 1

    if BEVEL_DEPTH_MM and BEVEL_DEPTH_MM > 0:
        curve_data.bevel_depth = BEVEL_DEPTH_MM * MM_TO_BU
        curve_data.bevel_resolution = BEVEL_RESOLUTION

    obj = bpy.data.objects.new(name="centerline_polylines_mm_centered", object_data=curve_data)
    col.objects.link(obj)

    Rx = Matrix.Rotation(math.radians(ROT_X_DEG), 4, 'X')

    n_added = 0
    for pl in polylines:
        pts = pl.get("points_mm", [])
        if pts is None or len(pts) < 2:
            continue

        sp = curve_data.splines.new(type='POLY')
        sp.points.add(len(pts) - 1)

        for i, (x, y, z) in enumerate(pts):
            # centered JSON なので “そのまま” mm→BU、回転だけでOK
            p_bu = Vector((x * MM_TO_BU, y * MM_TO_BU, z * MM_TO_BU))
            p_bu = (Rx @ p_bu.to_4d()).to_3d()
            sp.points[i].co = (p_bu.x, p_bu.y, p_bu.z, 1.0)

        n_added += 1

    if n_added == 0:
        raise ValueError("No valid polylines imported.")

    # ★ここが重要：centered JSONでは “再センタリングしない”
    obj.location = (0.0, 0.0, 0.0)
    obj.rotation_euler = (0.0, 0.0, 0.0)
    obj.scale = (1.0, 1.0, 1.0)

    bpy.ops.object.select_all(action='DESELECT')
    obj.select_set(True)
    bpy.context.view_layer.objects.active = obj

    print(f"[OK] Imported splines: {n_added}")
    print(f"Applied: MM_TO_BU={MM_TO_BU}, ROT_X={ROT_X_DEG} deg, NO recenter")
    return obj

# ---- RUN ----
import_centered_polylines_curve(JSON_PATH)
